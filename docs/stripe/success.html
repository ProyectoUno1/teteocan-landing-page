<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Â¡Pago Exitoso! - Tlatec</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="icon" href="/docs/assets/images/LogoTlatec.ico" type="image/x-icon" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="successStyle_v2.css" />
</head>

<body>
    <div class="success-container">
        <div class="success-header">
            <div class="success-icon"><i class="fas fa-check-circle"></i></div>
            <h1 class="success-title">Â¡Pago Exitoso!</h1>
            <p class="success-message">
                Tu suscripciÃ³n ha sido procesada correctamente. RecibirÃ¡s un correo de confirmaciÃ³n
                con todos los detalles de tu compra en los prÃ³ximos minutos.
            </p>
        </div>

        <div class="success-details">
            <div class="detail-item">
                <span>Estado del pago:</span>
                <span class="status-completed"><i class="fas fa-check-circle"></i> Completado</span>
            </div>
            <div class="detail-item">
                <span>MÃ©todo de pago:</span><span>Stripe</span>
            </div>
            <div class="detail-item">
                <span>Fecha:</span><span id="paymentDate"></span>
            </div>
        </div>

        <div class="info-section">
            <h4><i class="fas fa-clipboard-list"></i> PrÃ³ximos pasos:</h4>
            <ul>
                <li>RecibirÃ¡s un correo con los detalles de acceso</li>
                <li>Nuestro equipo se pondrÃ¡ en contacto contigo en 24 horas</li>
            </ul>
        </div>

        <a href="https://tlatec.teteocan.com/" class="btn-home">
            <i class="fas fa-home"></i> Volver al inicio
        </a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Mostrar fecha actual
        document.getElementById('paymentDate').textContent = new Date().toLocaleDateString('es-MX', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });

        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id');

        async function mostrarModalDeExtras() {
            if (!sessionId) return;

            try {
                const res = await fetch(`https://tlatec-backend.onrender.com/api/stripe/extras-pendientes/${sessionId}`);
                const data = await res.json();

                if (!res.ok || !data.servicios?.length) return;

                const servicios = data.servicios;
                const clienteEmail = data.cliente_email;

                Swal.fire({
                    title: 'ðŸŽ¯ SERVICIOS EXTRA DISPONIBLES',
                    html: `
            <div style="text-align: left; margin: 20px 0;">
              <p style="margin-bottom: 15px;">Â¿Deseas agregar ${servicios.length} servicios extra adicionales?</p>
              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <strong>ðŸ“‹ Servicios disponibles:</strong><br><br>
                ${servicios.map(s => `
                  <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #28a745;">
                    â€¢ <strong>${s.nombre}</strong> - $${s.precio.toLocaleString('es-MX')} MXN
                  </div>
                `).join('')}
              </div>
              <p style="color: #6c757d; font-size: 14px; margin-top: 15px;">
                ðŸ’¡ Puedes agregar estos servicios ahora o contactarnos despuÃ©s.
              </p>
            </div>
          `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'âœ… SÃ, AGREGAR EXTRAS',
                    cancelButtonText: 'âŒ NO, CONTINUAR SIN EXTRAS',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: 'â³ PROCESANDO EXTRAS...',
                            html: 'Espera un momento mientras procesamos tus servicios adicionales.',
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            didOpen: () => Swal.showLoading()
                        });

                        try {
                            const response = await fetch('https://tlatec-backend.onrender.com/api/stripe/pago-unico', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    clienteEmail,
                                    servicios,
                                    ventaId: null // opcional si ya se asocian por sessionId
                                })
                            });

                            const pago = await response.json();
                            if (response.ok && pago.url) {
                                window.location.href = pago.url;
                            } else {
                                throw new Error(pago.message || 'No se pudo generar el pago de extras');
                            }
                        } catch (err) {
                            console.error(err);
                            Swal.fire('Error', 'No se pudo procesar el pago de servicios extra.', 'error');
                        }
                    } else {
                        // Si el usuario no quiere pagar servicios extra, marcamos como cancelados
                        await fetch('https://tlatec-backend.onrender.com/api/stripe/extras/cancelar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ stripeSessionId: sessionId })
                        });

                        Swal.fire({
                            title: 'âœ… Â¡Perfecto!',
                            text: 'Tu suscripciÃ³n estÃ¡ completa. SerÃ¡s redirigido al inicio en unos segundos.',
                            icon: 'success',
                            timer: 3000,
                            showConfirmButton: false
                        });

                        
                    }
                });

            } catch (error) {
                console.error('Error al cargar servicios extra pendientes:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            mostrarModalDeExtras();

            const btnHome = document.querySelector('.btn-home');
            if (btnHome) {
                btnHome.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.href = 'https://tlatec.teteocan.com/';
                });
            }
        });
    </script>
</body>

</html>