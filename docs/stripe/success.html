<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¡Pago Exitoso! - Teteocan</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="icon" href="../assets/images/LogoTlatec.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="successStyle.css">
</head>
<body>
    <div class="success-container">
        <div class="success-header">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            
            <h1 class="success-title">¡Pago Exitoso!</h1>
            
            <p class="success-message">
                Tu suscripción ha sido procesada correctamente. Recibirás un correo de confirmación 
                con todos los detalles de tu compra en los próximos minutos.
            </p>
        </div>
        
        <div class="success-details">
            <div class="detail-item">
                <span>Estado del pago:</span>
                <span class="status-completed">
                    <i class="fas fa-check-circle"></i>
                    Completado
                </span>
            </div>
            <div class="detail-item">
                <span>Método de pago:</span>
                <span>Stripe</span>
            </div>
            <div class="detail-item">
                <span>Fecha:</span>
                <span id="paymentDate"></span>
            </div>
        </div>
        
        <div class="info-section">
            <h4><i class="fas fa-clipboard-list"></i> Próximos pasos:</h4>
            <ul>
                <li>Recibirás un correo con los detalles de acceso</li>
                <li>Nuestro equipo se pondrá en contacto contigo en 24 horas</li>
                <li>Comenzaremos la configuración de tu paquete</li>
                <li>Te proporcionaremos acceso a tu panel de control</li>
            </ul>
        </div>
        
        <a href="../index.html" class="btn-home">
            <i class="fas fa-home"></i> Volver al inicio
        </a>
    </div>    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Mostrar fecha actual
        document.getElementById('paymentDate').textContent = new Date().toLocaleDateString('es-MX', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Opcional: obtener parámetros de la URL para mostrar detalles específicos
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id');
        
        if (sessionId) {
            console.log('Session ID:', sessionId);
            // Aquí podrías hacer una llamada al backend para obtener detalles específicos
        }

        // Función para procesar servicios extra después de la suscripción
        async function procesarServiciosExtra(clienteEmail, servicios) {
            try {
                // Filtrar solo servicios con costo
                const serviciosConCosto = servicios.filter(servicio => servicio.precio > 0);
                
                if (serviciosConCosto.length === 0) {
                    console.log('No hay servicios extra con costo para procesar');
                    return { success: true, message: 'Solo servicios gratuitos' };
                }

                const response = await fetch('https://tlatec-backend.onrender.com/api/stripe/pago-unico', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        clienteEmail: clienteEmail,
                        servicios: serviciosConCosto
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    // Redirigir a Stripe para el pago de extras
                    window.location.href = data.url;
                    return data;
                } else {
                    throw new Error(data.message || 'Error al procesar servicios extra');
                }
            } catch (error) {
                console.error('Error procesando extras:', error);
                throw error;
            }
        }

        // Función para manejar el éxito de la suscripción y procesar extras
        function manejarExitoSuscripcion() {
            // Esta función se ejecuta en la página de éxito
            const extrasPendientes = localStorage.getItem('extrasPendientes');
            
            if (extrasPendientes) {
                const datos = JSON.parse(extrasPendientes);
                const serviciosConCosto = datos.extras.filter(extra => extra.precio > 0);
                
                if (serviciosConCosto.length > 0) {
                    // Mostrar modal o confirmación para procesar extras
                    Swal.fire({
                        title: 'SERVICIOS EXTRA DISPONIBLES',
                        html: `¿Deseas procesar ${serviciosConCosto.length} servicios extra adicionales?<br><br>
                               <strong>Servicios:</strong><br>
                               ${serviciosConCosto.map(s => `• ${s.nombre} - $${s.precio.toLocaleString('es-MX')}`).join('<br>')}`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'SÍ, PROCESAR EXTRAS',
                        cancelButtonText: 'NO, CONTINUAR SIN EXTRAS',
                        customClass: {
                            confirmButton: 'swal2-confirm',
                            cancelButton: 'swal2-cancel'
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            Swal.fire({
                                title: 'PROCESANDO EXTRAS...',
                                html: 'Espera un momento mientras procesamos tus servicios adicionales.',
                                allowOutsideClick: false,
                                didOpen: () => Swal.showLoading()
                            });

                            procesarServiciosExtra(datos.email, serviciosConCosto)
                                .then(() => {
                                    localStorage.removeItem('extrasPendientes');
                                })
                                .catch(error => {
                                    console.error('Error procesando extras:', error);
                                    Swal.fire('Error', 'Error al procesar servicios extra. Contacta soporte.', 'error');
                                });
                        } else {
                            localStorage.removeItem('extrasPendientes');
                        }
                    });
                } else {
                    localStorage.removeItem('extrasPendientes');
                }
            }
        }

        // Ejecutar cuando la página se carga completamente
        document.addEventListener('DOMContentLoaded', function() {
            // Esperar un poco para que la página se renderice completamente
            setTimeout(() => {
                manejarExitoSuscripcion();
            }, 1000);
        });
    </script>
</body>
</html>