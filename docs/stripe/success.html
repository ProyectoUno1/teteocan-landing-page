<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¡Pago Exitoso! - Tlatec</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="icon" href="/docs/assets/images/LogoTlatec.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="successStyle.css">
</head>
<body>
    <div class="success-container">
        <div class="success-header">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            
            <h1 class="success-title">¡Pago Exitoso!</h1>
            
            <p class="success-message">
                Tu suscripción ha sido procesada correctamente. Recibirás un correo de confirmación 
                con todos los detalles de tu compra en los próximos minutos.
            </p>
        </div>
        
        <div class="success-details">
            <div class="detail-item">
                <span>Estado del pago:</span>
                <span class="status-completed">
                    <i class="fas fa-check-circle"></i>
                    Completado
                </span>
            </div>
            <div class="detail-item">
                <span>Método de pago:</span>
                <span>Stripe</span>
            </div>
            <div class="detail-item">
                <span>Fecha:</span>
                <span id="paymentDate"></span>
            </div>
        </div>
        
        <div class="info-section">
            <h4><i class="fas fa-clipboard-list"></i> Próximos pasos:</h4>
            <ul>
                <li>Recibirás un correo con los detalles de acceso</li>
                <li>Nuestro equipo se pondrá en contacto contigo en 24 horas</li>
            </ul>
        </div>        <a href="../index.html" class="btn-home">
            <i class="fas fa-home"></i> Volver al inicio
        </a>
    </div>    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Mostrar fecha actual
        document.getElementById('paymentDate').textContent = new Date().toLocaleDateString('es-MX', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Opcional: obtener parámetros de la URL para mostrar detalles específicos
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id');
        
        if (sessionId) {
            console.log('Session ID:', sessionId);
        }

        // Función para procesar servicios extra después de la suscripción
        async function procesarServiciosExtra(clienteEmail, servicios) {
            try {
                console.log('Procesando servicios extra:', servicios);
                
                // Filtrar solo servicios con costo
                const serviciosConCosto = servicios.filter(servicio => servicio.precio > 0);
                
                if (serviciosConCosto.length === 0) {
                    console.log('No hay servicios extra con costo para procesar');
                    return { success: true, message: 'Solo servicios gratuitos' };
                }

                const response = await fetch('https://tlatec-backend.onrender.com/api/stripe/pago-unico', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        clienteEmail: clienteEmail,
                        servicios: serviciosConCosto
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    console.log('Redirigiendo a pago de extras:', data.url);
                    // Redirigir a Stripe para el pago de extras
                    window.location.href = data.url;
                    return data;
                } else {
                    throw new Error(data.message || 'Error al procesar servicios extra');
                }
            } catch (error) {
                console.error('Error procesando extras:', error);
                throw error;
            }
        }

        // Función para redirigir al inicio después de un tiempo
        function redirigirAlInicio(tiempo = 5000) {
            setTimeout(() => {
                console.log('Redirigiendo al inicio...');
                window.location.href = '../index.html';
            }, tiempo);
        }

        // Función para manejar el éxito de la suscripción y procesar extras
        function manejarExitoSuscripcion() {
            console.log('Iniciando manejo de éxito de suscripción...');
            
            // Esta función se ejecuta en la página de éxito
            const extrasPendientes = localStorage.getItem('extrasPendientes');
            console.log('Extras pendientes encontrados:', extrasPendientes);
            
            if (extrasPendientes) {
                try {
                    const datos = JSON.parse(extrasPendientes);
                    console.log('Datos parseados:', datos);
                    
                    if (!datos.extras || !Array.isArray(datos.extras)) {
                        console.log('No hay extras válidos en los datos');
                        localStorage.removeItem('extrasPendientes');
                        redirigirAlInicio();
                        return;
                    }
                    
                    const serviciosConCosto = datos.extras.filter(extra => extra.precio > 0);
                    console.log('Servicios con costo encontrados:', serviciosConCosto);
                    
                    if (serviciosConCosto.length > 0) {
                        // Mostrar modal o confirmación para procesar extras
                        Swal.fire({
                            title: '🎯 SERVICIOS EXTRA DISPONIBLES',
                            html: `
                                <div style="text-align: left; margin: 20px 0;">
                                    <p style="margin-bottom: 15px;">¿Deseas agregar ${serviciosConCosto.length} servicios extra adicionales?</p>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                        <strong>📋 Servicios disponibles:</strong><br><br>
                                        ${serviciosConCosto.map(s => `
                                            <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #28a745;">
                                                • <strong>${s.nombre}</strong> - $${s.precio.toLocaleString('es-MX')} MXN
                                            </div>
                                        `).join('')}
                                    </div>
                                    <p style="color: #6c757d; font-size: 14px; margin-top: 15px;">
                                        💡 Puedes agregar estos servicios ahora o contactarnos después.
                                    </p>
                                </div>
                            `,
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: '✅ SÍ, AGREGAR EXTRAS',
                            cancelButtonText: '❌ NO, CONTINUAR SIN EXTRAS',
                            customClass: {
                                confirmButton: 'swal2-confirm',
                                cancelButton: 'swal2-cancel'
                            },
                            buttonsStyling: true,
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        }).then((result) => {
                            if (result.isConfirmed) {
                                Swal.fire({
                                    title: '⏳ PROCESANDO EXTRAS...',
                                    html: 'Espera un momento mientras procesamos tus servicios adicionales.',
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    didOpen: () => Swal.showLoading()
                                });

                                procesarServiciosExtra(datos.email, serviciosConCosto)
                                    .then(() => {
                                        localStorage.removeItem('extrasPendientes');
                                    })
                                    .catch(error => {
                                        console.error('Error procesando extras:', error);
                                        Swal.fire({
                                            title: '❌ Error',
                                            text: 'Error al procesar servicios extra. Por favor contacta a soporte.',
                                            icon: 'error',
                                            confirmButtonText: 'Entendido'
                                        }).then(() => {
                                            localStorage.removeItem('extrasPendientes');
                                            redirigirAlInicio();
                                        });
                                    });
                            } else {
                                console.log('Usuario decidió no procesar extras');
                                localStorage.removeItem('extrasPendientes');
                                
                                Swal.fire({
                                    title: '✅ ¡Perfecto!',
                                    text: 'Tu suscripción está completa. Serás redirigido al inicio en unos segundos.',
                                    icon: 'success',
                                    timer: 3000,
                                    showConfirmButton: false
                                });
                                
                                redirigirAlInicio(3000);
                            }
                        });
                    } else {
                        console.log('No hay servicios con costo, limpiando localStorage');
                        localStorage.removeItem('extrasPendientes');
                        redirigirAlInicio();
                    }
                } catch (error) {
                    console.error('Error parseando extrasPendientes:', error);
                    localStorage.removeItem('extrasPendientes');
                    redirigirAlInicio();
                }
            } else {
                console.log('No hay extras pendientes, redirigiendo al inicio');
                redirigirAlInicio();
            }
        }

        // Ejecutar cuando la página se carga completamente
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, iniciando proceso...');
            
            // Esperar un poco para que la página se renderice completamente
            setTimeout(() => {
                manejarExitoSuscripcion();
            }, 1500);
        });

        // Agregar evento al botón de volver al inicio
        document.addEventListener('DOMContentLoaded', function() {
            const btnHome = document.querySelector('.btn-home');
            if (btnHome) {
                btnHome.addEventListener('click', function(e) {
                    e.preventDefault();
                    localStorage.removeItem('extrasPendientes');
                    window.location.href = '../index.html';
                });
            }
        });
    </script>
</body>
</html>